== CTAP 2.2: Enhanced FIDO2 Features and Enterprise Security
:description: Comprehensive guide to CTAP 2.2 features including Persistent PIN/UV Auth Tokens, PIN complexity policies, and enterprise attestation. Learn implementation with Yubico SDKs.
:keywords: CTAP 2.2, FIDO2, persistent PIN tokens, PIN complexity, enterprise attestation, thirdPartyPayment, credential management, alwaysUv, YubiKey SDK
:author: Yubico Developer Relations
:page-layout: technical-guide
:page-category: Authentication Protocols
:page-tags: CTAP 2.2, FIDO2, Enterprise Security, PIN Policies, Payment Authentication
:toc: left
:toclevels: 4
:sectanchors:
:source-highlighter: highlight.js
:page-last-updated: 2025-01-15

[.lead]
CTAP 2.2 delivers powerful new capabilities for enterprise deployments and improved user experiences. This technical guide walks you through persistent PIN tokens, advanced credential management, payment authentication, and other protocol enhancements—with concrete examples showing how to implement them using Yubico's developer tools.

=== CTAP 2.2: Protocol Advances for Enterprise and Ecosystem Growth

==== Introduction

The Client to Authenticator Protocol (CTAP) defines how authenticators communicate with clients for FIDO2 authentication. CTAP 2.2 strengthens the protocol with features that address enterprise deployment requirements and expand authentication options across the FIDO ecosystem.

For roaming authenticators like YubiKeys, this release delivers capabilities that reduce friction in enterprise workflows: persistent PIN/UV auth tokens eliminate repeated prompts during credential management, PIN complexity policies enforce compliance requirements at the hardware level, and the thirdPartyPayment extension enables cross-domain authentication for regulated payment transactions.

CTAP 2.2 also formalizes hybrid transport, a protocol mechanism for cross-device authentication using QR codes and proximity pairing. This allows a platform authenticator on a phone to authenticate sessions on other devices like desktops—useful for everyday scenarios where convenience matters more than the highest assurance levels. Hybrid flows can create single-device credentials (hardware-bound, like YubiKeys) or multi-device credentials (syncable across a user's devices). For scenarios requiring attestation and non-exportable keys, hardware security keys remain the appropriate authenticator choice.

This guide covers CTAP 2.2 features from an implementation perspective, with specific guidance for Yubico SDKs. Many features operate at the native application layer—check our link:https://developers.yubico.com/WebAuthn/WebAuthn_Browser_Support/[browser support matrix] for WebAuthn API availability.

[NOTE]
====
**WebAuthn and Browser Support**: While CTAP 2.2 features are available at the protocol level, WebAuthn applications depend on browser support for these capabilities. Not all CTAP 2.2 features are exposed through the WebAuthn JavaScript API, and browser implementations vary. For web developers, consult our link:https://developers.yubico.com/WebAuthn/WebAuthn_Browser_Support/[WebAuthn Browser Support] page to verify which features your target browsers support before implementation.
====

==== What's New in CTAP 2.2

CTAP 2.2 introduces new protocol capabilities and expands features established in CTAP 2.1. The table below highlights major changes, organized by relevance to roaming authenticators like YubiKeys.

[cols="2,3,3", options="header"]
|===
| Feature | Description | Developer Benefit

| **Persistent PIN/UV Auth Tokens (PPUAT)** +
_(New in 2.2)_
| Long-lived tokens for read-only credential management operations, eliminating repeated PIN prompts during credential discovery across multiple relying parties.
| Dramatically improves UX in enterprise SSO portals and password managers. Reduces authentication fatigue in multi-step workflows where users enumerate credentials.

| **PIN Complexity Policies** +
_(Expanded in 2.2)_
| Hardware-enforced PIN requirements including character set constraints. Expands CTAP 2.1's minimum PIN length enforcement to full complexity policies.
| Meets enterprise compliance requirements (NIST SP 800-63B) at the authenticator level. Security policies cannot be circumvented by clients.

| **thirdPartyPayment Extension** +
_(New in 2.2)_
| Enables Secure Payment Confirmation (SPC) by allowing credentials created on one domain (e.g., a bank) to authenticate on another domain (e.g., a merchant checkout).
| Critical for payment industry compliance with PSD2 Strong Customer Authentication. Enables standardized, phishing-resistant payment flows required by card networks and regulators.

| **Enhanced Authenticator Metadata (getInfo)** +
_(Expanded in 2.2)_
| Richer self-description capabilities including UV counters, supported attestation formats, PIN complexity policy details, and maximum PIN length.
| Enables adaptive client behavior. Applications can dynamically adjust UI and validation logic based on authenticator capabilities without trial-and-error probing.

| **Increased Enterprise RPID Storage** +
_(Expanded in 2.2)_
| Support for up to 16 Relying Party IDs for Enterprise Attestation, increased from 2 in CTAP 2.1.
| Simplifies authenticator management for enterprises with multiple IdPs or dev/staging/production environments. Eliminates need for separate authenticators per organizational domain.

| **Hybrid Transport** +
_(New in 2.2)_
| Cross-device authentication using QR code initiation and proximity-based pairing (BLE + network tunnel). Enables a platform authenticator on one device to authenticate sessions on another.
| Expands FIDO adoption for consumer applications where convenience is prioritized. Developers can implement passwordless experiences that leverage users' existing devices.

| **JSON-Based Messaging** +
_(New in 2.2)_
| Optional JSON encoding for specific CTAP commands, supplementing the existing CBOR format. Primarily used in browser-mediated credential management contexts.
| Simplifies integration for web-based credential management UIs. JavaScript applications can parse authenticator responses without CBOR decoding in certain scenarios.

| **Persistent Credential Management Read-Only (pcmr)** +
_(New in 2.2)_
| New permission level for credential management that allows querying stored credentials without granting delete capabilities. Enables safer credential enumeration for auditing and UI purposes.
| Allows browsers and credential managers to display available passkeys without risking accidental deletion. Useful for enterprise audit tools that need read-only credential visibility.

| **HMAC-Secret Multi-Credential (hmac-secret-mc) / PRF** +
_(New in 2.2)_
| Extension that allows deriving credential-specific secrets during registration, not just authentication. Builds on CTAP 2.1's hmac-secret by enabling secret derivation at credential creation time.
| Enables immediate encryption of local data with hardware-backed secrets during registration. Critical for password managers, encrypted vaults, and offline workstation scenarios that need secrets before first authentication.

| **Asynchronous Remote Key Generation (ARKG)** +
_(New in 2.2)_
| Advanced cryptographic extension enabling distributed key generation where the private key remains on the authenticator while the public key can be independently computed remotely.
| Enables sophisticated protocols like threshold authentication and privacy-preserving credentials. Primarily relevant for cryptographic research and advanced identity systems.
|===

[NOTE]
====
**Protocol Capabilities vs Device Support**: This table reflects CTAP 2.2 protocol features. Individual authenticator implementations vary—check YubiKey firmware documentation and SDK support matrices for specific device capabilities.
====

==== CTAP 2.2 Features Explained

===== Persistent PIN/UV Auth Tokens (PPUAT)

Spec:: Allows persistent tokens for credential discovery without repeated PIN entry.
Use Case:: Enterprise SSO portals where users browse multiple apps in one session.
Yubico Support:: Available in Yubico.NET SDK, yubikit-android, and python-fido2.

Persistent PIN/UV auth tokens solve a common UX problem: when an application needs to enumerate credentials across multiple relying parties, users would previously need to re-enter their PIN for each discovery operation. PPUATs allow the authenticator to issue a longer-lived token specifically for read-only credential management operations, dramatically improving the experience in enterprise portals and password managers.

[source,csharp]
----
// This C# example demonstrates retrieving a persistent token
// to enumerate credentials without re-prompting the user for a PIN.
using Yubico.YubiKey.Fido2;

var fido2Session = new Fido2Session(yubiKeyDevice);
var token = fido2Session.GetPersistentPinUvAuthToken();
var credentials = fido2Session.GetCredentials(token);
----

[CAUTION]
====
**Browser Limitation**: PPUATs are a protocol-level feature not currently exposed through WebAuthn APIs. This feature is primarily useful for native applications that communicate directly with authenticators via CTAP.
====

===== PIN Complexity Policies

Spec:: Authenticators can enforce stronger PIN rules (length, charset).
Use Case:: Enterprises subject to NIST SP 800-63B or similar requirements.
Yubico Support:: Available in Yubico.NET SDK, libfido2, and python-fido2.

Organizations with strict security policies can now enforce PIN complexity at the hardware level. Security keys can be configured to require minimum PIN lengths beyond the default, helping meet compliance requirements without relying solely on policy enforcement at the application layer.

[source,python]
----
# This Python example uses python-fido2 to query an authenticator's
# capabilities and print its PIN complexity policy, if available.
from fido2.hid import CtapHidDevice
from fido2.client import Fido2Client

dev = next(CtapHidDevice.list_devices())
client = Fido2Client(dev, "https://example.com")
info = client.info
print(f"PIN complexity: {info.options.get('pinComplexity')}")
print(f"Max PIN length: {info.max_pin_length}")
----

===== thirdPartyPayment Extension

Spec:: Enables Secure Payment Confirmation (SPC) with cross-domain credential use.
Use Case:: Payment providers integrating PSD2 SCA.
Yubico Support:: Available in Yubico.NET SDK, yubikit-android, and python-fido2.

The thirdPartyPayment extension enables a critical capability for the payment industry: allowing credentials created on one domain (e.g., a bank's website) to be used for authentication on another domain (e.g., a merchant's checkout page). This is essential for Secure Payment Confirmation workflows required by regulations like PSD2.

[source,kotlin]
----
// This Kotlin snippet for Android shows how to request an assertion
// with the thirdPartyPayment extension enabled.
val fido2Session = Fido2Session(yubiKey)
// The PaymentExtension is a helper class representing the CTAP2 extension data.
val paymentOptions = PaymentExtension("thirdPartyPayment", true)
val result = fido2Session.getAssertion(rpId, paymentOptions)
----

[NOTE]
====
**Browser Support Required**: Secure Payment Confirmation requires coordinated browser support. Check our link:https://developers.yubico.com/WebAuthn/WebAuthn_Browser_Support/[browser support matrix] before implementing SPC workflows, as browser adoption is still evolving.
====

===== Persistent Credential Management – Read-only (pcmr)

Spec:: Allows applications to query stored credentials with structured details, without granting delete permissions.
Use Case:: Enterprise credential audits, lifecycle reporting, and enabling browsers to safely list passkeys for an improved UX.
Yubico Support:: Defined in CTAP 2.2 specification but not yet exposed in Yubico SDKs.

The pcmr permission enables credential enumeration without the destructive capabilities of full credential management. This is particularly valuable for audit tools and browser implementations that want to display available passkeys without risking accidental deletion.

===== hmac-secret-mc / PRF

Spec:: Provides a multi-credential variant of hmac-secret that can be invoked during credential creation.
Use Case:: Applications needing per-credential secrets for encrypting local data—for example, password managers encrypting vaults or sync systems deriving encryption keys.
Yubico Support:: Available in Yubico.NET SDK, yubikit-android, and python-fido2.

The hmac-secret-mc extension (exposed in WebAuthn as the PRF extension) allows applications to derive credential-specific secrets during registration rather than only during authentication. This unlocks powerful patterns: apps can immediately encrypt data with a hardware-backed secret, without requiring the user to authenticate first.

[TIP]
====
**Learn More About PRF**: For comprehensive implementation guidance, see our PRF extension documentation:

* link:https://developers.yubico.com/WebAuthn/Concepts/PRF_Extension/[PRF Extension Overview]
* link:https://developers.yubico.com/WebAuthn/Concepts/PRF_Extension/Developers_Guide_to_PRF.html[Developer's Guide to PRF]
* link:https://developers.yubico.com/WebAuthn/Concepts/PRF_Extension/CTAP2_HMAC_Secret_Deep_Dive.html[CTAP2 HMAC-Secret Deep Dive]

These guides walk you through practical use cases like building end-to-end encrypted applications and implementing secure offline workstation access.
====

[NOTE]
====
**WebAuthn Integration**: The PRF extension is exposed through WebAuthn and has growing browser support. However, implementation details vary—consult our link:https://developers.yubico.com/WebAuthn/WebAuthn_Browser_Support/[browser compatibility guide] for current support status across platforms.
====

===== ARKG Extension

Spec:: Asynchronous Remote Key Generation enables authenticators to participate in advanced key agreement protocols where the private key remains on the device while the public key can be computed remotely.
Use Case:: Advanced cryptographic protocols requiring distributed key generation, such as decentralized identity systems, threshold signatures, and privacy-preserving authentication schemes.
Yubico Support:: Defined in CTAP 2.2 specification but not currently exposed in Yubico SDKs.

ARKG enables a cryptographic technique where an authenticator generates a key pair in such a way that while the private key remains securely on the device, a remote party can independently derive the corresponding public key without ever seeing the private key. This is accomplished through elliptic curve cryptography and key blinding techniques.

This capability opens doors for sophisticated protocols: threshold authentication systems where multiple parties must cooperate, privacy-preserving credential systems, and decentralized identity frameworks where identity providers need to compute public keys for credentials without the authenticator revealing sensitive key material.

For technical details on the cryptographic construction and security properties, see the link:https://datatracker.ietf.org/doc/draft-bradleylundberg-cfrg-arkg/[ARKG IETF draft specification].

===== Hybrid Transport

Spec:: Cross-device authentication protocol using QR codes and BLE proximity pairing.
Use Case:: Enables FIDO authentication on devices without built-in authenticators by leveraging a phone's platform authenticator.
Yubico Support:: Not applicable—hybrid transport is implemented by platform authenticators and clients, not roaming security keys.

Hybrid transport allows a platform authenticator on a phone to complete authentication for sessions on other devices like desktops. The user scans a QR code displayed on the desktop, and the phone establishes a secure connection via BLE and an encrypted tunnel to complete the FIDO ceremony.

[NOTE]
====
**Implementation Note**: Browsers and operating systems handle hybrid transport. Application developers design flows that support both roaming authenticators and cross-device authentication, depending on user hardware availability.
====

===== JSON-Based Messaging

Spec:: Optional JSON encoding for credential management commands, supplementing CBOR.
Use Case:: Browser credential management UIs.
Yubico Support:: Transparent to SDK usage—Yubico SDKs use CBOR when communicating with YubiKeys.

CTAP 2.2 allows JSON encoding for specific credential management operations. This simplifies browser implementations that would otherwise need CBOR decoding in JavaScript. The core protocol continues using CBOR.

===== Increased RPID Storage for Enterprises

Spec:: Security keys supporting CTAP 2.2 can store up to 16 Relying Party IDs for Enterprise Attestation, up from 2 in CTAP 2.1.
Use Case:: Organizations with multiple identity providers or separate development, staging, and production environments (e.g., dev.example.com, staging.example.com, prod.example.com).
Yubico Support:: Check security key firmware documentation for specific implementation details.

Enterprise Attestation allows organizations to configure security keys that return uniquely identifying attestation only for pre-approved relying party IDs. The increased storage from 2 to 16 RPIDs simplifies management for enterprises with complex infrastructure, eliminating the need for separate keys across environments.

===== getInfo Metadata Extensions

Spec:: Richer authenticator self-description including PIN complexity policies, attestation formats, UV counters, and more.
Use Case:: Applications that adapt their behavior based on authenticator capabilities—for example, adjusting PIN requirements or choosing attestation verification strategies.
Yubico Support:: Available in Yubico.NET SDK, yubikit-android, python-fido2, and exposed via libfido2/fido2-token.

CTAP 2.2 expands the authenticatorGetInfo response with fields like:

* `uvCountSinceLastPinEntry` - helps detect if user verification has been performed recently
* `attestationFormats` - lists supported attestation statement formats
* `pinComplexityPolicy` - describes enforced PIN requirements
* `maxPinLength` - useful for UI validation

These metadata fields enable smarter application behavior without trial-and-error probing of authenticator capabilities.

==== Yubico SDKs and CTAP 2.2 Support

[cols="1,1,1", options="header"]
|===
| SDK | CTAP 2.2 Support | Notes
| python-fido2 | ✅ Full Support | v2.0.0+ supports PPUAT, hmac-secret-mc, thirdPartyPayment, and expanded getInfo fields. Foundation for other Yubico tools.
| Yubico.NET SDK | ✅ Extensive Support | v1.14.0+ supports PPUAT, PIN complexity policies, thirdPartyPayment, hmac-secret-mc, and expanded getInfo properties.
| yubikit-android | ✅ Good Support | v2.9.0+ supports PPUAT, hmac-secret-mc, thirdPartyPayment, and expanded getInfo members. Actively maintained.
| libfido2 / fido2-token | ⚠️ Limited | C library and command-line tools. CTAP 2.2 feature support not yet documented in releases through v1.16.0.
| yubikit-swift | ⚠️ Limited | Modern Swift SDK for iOS/macOS. CTAP 2.2 feature support under development.
| yubikit-ios (Objective-C) | ⚠️ Limited | Legacy Objective-C SDK. Missing most CTAP 2.2 features. Consider yubikit-swift for new projects.
|===

[NOTE]
====
**Feature Coverage**: pcmr and ARKG extensions are defined in CTAP 2.2 but not yet exposed in current SDK releases. Hybrid transport and JSON messaging are handled by browsers and operating systems, not SDK implementations.
====

===== References

* link:https://github.com/Yubico/Yubico.NET.SDK/[Yubico.NET SDK on GitHub]
* link:https://github.com/Yubico/yubikit-android[yubikit-android on GitHub]
* link:https://github.com/Yubico/python-fido2[python-fido2 on GitHub]
* link:https://github.com/Yubico/libfido2[libfido2 on GitHub]
* link:https://github.com/Yubico/yubikit-ios[yubikit-ios on GitHub]
* link:https://github.com/Yubico/yubikit-swift[yubikit-swift on GitHub]
* link:https://fidoalliance.org/specs/fido-v2.2-ps-20250714/fido-client-to-authenticator-protocol-v2.2-ps-20250714.html[CTAP 2.2 Specification (FIDO Alliance)]
* link:https://datatracker.ietf.org/doc/draft-bradleylundberg-cfrg-arkg/[ARKG IETF Draft Specification]
* link:https://developers.yubico.com/WebAuthn/WebAuthn_Browser_Support/[WebAuthn Browser Support Matrix]

==== Where to Learn More

* link:https://fidoalliance.org/specifications/[FIDO Alliance Specifications]
* link:https://github.com/Yubico[Yubico on GitHub]
* link:https://support.yubico.com[Yubico Support]

[.text-center]
_Have questions about implementing CTAP 2.2 features? Visit our link:https://support.yubico.com[Support Portal] or join the conversation in our link:https://github.com/Yubico[GitHub repositories]._