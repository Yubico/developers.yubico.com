<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>yubikit.openpgp &mdash; yubikey-manager 5.2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=0fa48458"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            yubikey-manager
          </a>
              <div class="version">
                5.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rst/packages.html">yubikey-manager</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">yubikey-manager</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">yubikit.openpgp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for yubikit.openpgp</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2023 Yubico AB</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#   Redistribution and use in source and binary forms, with or</span>
<span class="c1">#   without modification, are permitted provided that the following</span>
<span class="c1">#   conditions are met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer.</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above</span>
<span class="c1">#       copyright notice, this list of conditions and the following</span>
<span class="c1">#       disclaimer in the documentation and/or other materials provided</span>
<span class="c1">#       with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1"># &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1"># LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<span class="c1"># COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="c1"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="c1"># BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="c1"># LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<span class="c1"># ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Tlv</span><span class="p">,</span>
    <span class="n">Version</span><span class="p">,</span>
    <span class="n">NotSupportedError</span><span class="p">,</span>
    <span class="n">InvalidPinError</span><span class="p">,</span>
    <span class="n">require_version</span><span class="p">,</span>
    <span class="n">int2bytes</span><span class="p">,</span>
    <span class="n">bytes2int</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.core.smartcard</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SmartCardConnection</span><span class="p">,</span>
    <span class="n">SmartCardProtocol</span><span class="p">,</span>
    <span class="n">ApduFormat</span><span class="p">,</span>
    <span class="n">ApduError</span><span class="p">,</span>
    <span class="n">AID</span><span class="p">,</span>
    <span class="n">SW</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">cryptography</span> <span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.serialization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Encoding</span><span class="p">,</span>
    <span class="n">PrivateFormat</span><span class="p">,</span>
    <span class="n">PublicFormat</span><span class="p">,</span>
    <span class="n">NoEncryption</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">ed25519</span><span class="p">,</span> <span class="n">x25519</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Prehashed</span><span class="p">,</span>
    <span class="n">encode_dss_signature</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">IntEnum</span><span class="p">,</span> <span class="n">IntFlag</span><span class="p">,</span> <span class="n">unique</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">SupportsBytes</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DEFAULT_USER_PIN</span> <span class="o">=</span> <span class="s2">&quot;123456&quot;</span>
<span class="n">DEFAULT_ADMIN_PIN</span> <span class="o">=</span> <span class="s2">&quot;12345678&quot;</span>


<div class="viewcode-block" id="UIF"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.UIF">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">UIF</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
    <span class="n">OFF</span> <span class="o">=</span> <span class="mh">0x00</span>
    <span class="n">ON</span> <span class="o">=</span> <span class="mh">0x01</span>
    <span class="n">FIXED</span> <span class="o">=</span> <span class="mh">0x02</span>
    <span class="n">CACHED</span> <span class="o">=</span> <span class="mh">0x03</span>
    <span class="n">CACHED_FIXED</span> <span class="o">=</span> <span class="mh">0x04</span>

<div class="viewcode-block" id="UIF.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.UIF.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">GENERAL_FEATURE_MANAGEMENT</span><span class="o">.</span><span class="n">BUTTON</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">FIXED</span><span class="p">,</span> <span class="n">UIF</span><span class="o">.</span><span class="n">CACHED_FIXED</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">CACHED</span><span class="p">,</span> <span class="n">UIF</span><span class="o">.</span><span class="n">CACHED_FIXED</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">UIF</span><span class="o">.</span><span class="n">FIXED</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;On (fixed)&quot;</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">UIF</span><span class="o">.</span><span class="n">CACHED_FIXED</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Cached (fixed)&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>


<div class="viewcode-block" id="PIN_POLICY"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PIN_POLICY">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">PIN_POLICY</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
    <span class="n">ALWAYS</span> <span class="o">=</span> <span class="mh">0x00</span>
    <span class="n">ONCE</span> <span class="o">=</span> <span class="mh">0x01</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>


<div class="viewcode-block" id="INS"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.INS">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">INS</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
    <span class="n">VERIFY</span> <span class="o">=</span> <span class="mh">0x20</span>
    <span class="n">CHANGE_PIN</span> <span class="o">=</span> <span class="mh">0x24</span>
    <span class="n">RESET_RETRY_COUNTER</span> <span class="o">=</span> <span class="mh">0x2C</span>
    <span class="n">PSO</span> <span class="o">=</span> <span class="mh">0x2A</span>
    <span class="n">ACTIVATE</span> <span class="o">=</span> <span class="mh">0x44</span>
    <span class="n">GENERATE_ASYM</span> <span class="o">=</span> <span class="mh">0x47</span>
    <span class="n">GET_CHALLENGE</span> <span class="o">=</span> <span class="mh">0x84</span>
    <span class="n">INTERNAL_AUTHENTICATE</span> <span class="o">=</span> <span class="mh">0x88</span>
    <span class="n">SELECT_DATA</span> <span class="o">=</span> <span class="mh">0xA5</span>
    <span class="n">GET_DATA</span> <span class="o">=</span> <span class="mh">0xCA</span>
    <span class="n">PUT_DATA</span> <span class="o">=</span> <span class="mh">0xDA</span>
    <span class="n">PUT_DATA_ODD</span> <span class="o">=</span> <span class="mh">0xDB</span>
    <span class="n">TERMINATE</span> <span class="o">=</span> <span class="mh">0xE6</span>
    <span class="n">GET_VERSION</span> <span class="o">=</span> <span class="mh">0xF1</span>
    <span class="n">SET_PIN_RETRIES</span> <span class="o">=</span> <span class="mh">0xF2</span>
    <span class="n">GET_ATTESTATION</span> <span class="o">=</span> <span class="mh">0xFB</span></div>


<span class="n">_INVALID_PIN</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">8</span>


<span class="n">TAG_DISCRETIONARY</span> <span class="o">=</span> <span class="mh">0x73</span>
<span class="n">TAG_EXTENDED_CAPABILITIES</span> <span class="o">=</span> <span class="mh">0xC0</span>
<span class="n">TAG_FINGERPRINTS</span> <span class="o">=</span> <span class="mh">0xC5</span>
<span class="n">TAG_CA_FINGERPRINTS</span> <span class="o">=</span> <span class="mh">0xC6</span>
<span class="n">TAG_GENERATION_TIMES</span> <span class="o">=</span> <span class="mh">0xCD</span>
<span class="n">TAG_SIGNATURE_COUNTER</span> <span class="o">=</span> <span class="mh">0x93</span>
<span class="n">TAG_KEY_INFORMATION</span> <span class="o">=</span> <span class="mh">0xDE</span>
<span class="n">TAG_PUBLIC_KEY</span> <span class="o">=</span> <span class="mh">0x7F49</span>


<div class="viewcode-block" id="PW"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PW">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">PW</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="mh">0x81</span>
    <span class="n">RESET</span> <span class="o">=</span> <span class="mh">0x82</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="mh">0x83</span></div>


<div class="viewcode-block" id="DO"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.DO">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">DO</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">PRIVATE_USE_1</span> <span class="o">=</span> <span class="mh">0x0101</span>
    <span class="n">PRIVATE_USE_2</span> <span class="o">=</span> <span class="mh">0x0102</span>
    <span class="n">PRIVATE_USE_3</span> <span class="o">=</span> <span class="mh">0x0103</span>
    <span class="n">PRIVATE_USE_4</span> <span class="o">=</span> <span class="mh">0x0104</span>
    <span class="n">AID</span> <span class="o">=</span> <span class="mh">0x4F</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="mh">0x5B</span>
    <span class="n">LOGIN_DATA</span> <span class="o">=</span> <span class="mh">0x5E</span>
    <span class="n">LANGUAGE</span> <span class="o">=</span> <span class="mh">0xEF2D</span>
    <span class="n">SEX</span> <span class="o">=</span> <span class="mh">0x5F35</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="mh">0x5F50</span>
    <span class="n">HISTORICAL_BYTES</span> <span class="o">=</span> <span class="mh">0x5F52</span>
    <span class="n">EXTENDED_LENGTH_INFO</span> <span class="o">=</span> <span class="mh">0x7F66</span>
    <span class="n">GENERAL_FEATURE_MANAGEMENT</span> <span class="o">=</span> <span class="mh">0x7F74</span>
    <span class="n">CARDHOLDER_RELATED_DATA</span> <span class="o">=</span> <span class="mh">0x65</span>
    <span class="n">APPLICATION_RELATED_DATA</span> <span class="o">=</span> <span class="mh">0x6E</span>
    <span class="n">ALGORITHM_ATTRIBUTES_SIG</span> <span class="o">=</span> <span class="mh">0xC1</span>
    <span class="n">ALGORITHM_ATTRIBUTES_DEC</span> <span class="o">=</span> <span class="mh">0xC2</span>
    <span class="n">ALGORITHM_ATTRIBUTES_AUT</span> <span class="o">=</span> <span class="mh">0xC3</span>
    <span class="n">ALGORITHM_ATTRIBUTES_ATT</span> <span class="o">=</span> <span class="mh">0xDA</span>
    <span class="n">PW_STATUS_BYTES</span> <span class="o">=</span> <span class="mh">0xC4</span>
    <span class="n">FINGERPRINT_SIG</span> <span class="o">=</span> <span class="mh">0xC7</span>
    <span class="n">FINGERPRINT_DEC</span> <span class="o">=</span> <span class="mh">0xC8</span>
    <span class="n">FINGERPRINT_AUT</span> <span class="o">=</span> <span class="mh">0xC9</span>
    <span class="n">FINGERPRINT_ATT</span> <span class="o">=</span> <span class="mh">0xDB</span>
    <span class="n">CA_FINGERPRINT_1</span> <span class="o">=</span> <span class="mh">0xCA</span>
    <span class="n">CA_FINGERPRINT_2</span> <span class="o">=</span> <span class="mh">0xCB</span>
    <span class="n">CA_FINGERPRINT_3</span> <span class="o">=</span> <span class="mh">0xCC</span>
    <span class="n">CA_FINGERPRINT_4</span> <span class="o">=</span> <span class="mh">0xDC</span>
    <span class="n">GENERATION_TIME_SIG</span> <span class="o">=</span> <span class="mh">0xCE</span>
    <span class="n">GENERATION_TIME_DEC</span> <span class="o">=</span> <span class="mh">0xCF</span>
    <span class="n">GENERATION_TIME_AUT</span> <span class="o">=</span> <span class="mh">0xD0</span>
    <span class="n">GENERATION_TIME_ATT</span> <span class="o">=</span> <span class="mh">0xDD</span>
    <span class="n">RESETTING_CODE</span> <span class="o">=</span> <span class="mh">0xD3</span>
    <span class="n">UIF_SIG</span> <span class="o">=</span> <span class="mh">0xD6</span>
    <span class="n">UIF_DEC</span> <span class="o">=</span> <span class="mh">0xD7</span>
    <span class="n">UIF_AUT</span> <span class="o">=</span> <span class="mh">0xD8</span>
    <span class="n">UIF_ATT</span> <span class="o">=</span> <span class="mh">0xD9</span>
    <span class="n">SECURITY_SUPPORT_TEMPLATE</span> <span class="o">=</span> <span class="mh">0x7A</span>
    <span class="n">CARDHOLDER_CERTIFICATE</span> <span class="o">=</span> <span class="mh">0x7F21</span>
    <span class="n">KDF</span> <span class="o">=</span> <span class="mh">0xF9</span>
    <span class="n">ALGORITHM_INFORMATION</span> <span class="o">=</span> <span class="mh">0xFA</span>
    <span class="n">ATT_CERTIFICATE</span> <span class="o">=</span> <span class="mh">0xFC</span></div>


<span class="k">def</span> <span class="nf">_bcd</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span>


<div class="viewcode-block" id="OpenPgpAid"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpAid">[docs]</a><span class="k">class</span> <span class="nc">OpenPgpAid</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenPGP Application Identifier (AID)</span>

<span class="sd">    The OpenPGP AID is a string of bytes identifying the OpenPGP application.</span>
<span class="sd">    It also embeds some values which are accessible though properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;OpenPGP version (tuple of 2 integers: main version, secondary version).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_bcd</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">_bcd</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manufacturer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;16-bit integer value identifying the manufacturer of the device.</span>

<span class="sd">        This should be 6 for Yubico devices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">bytes2int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The serial number of the YubiKey.</span>

<span class="sd">        NOTE: This value is encoded in BCD. In the event of an invalid value (hex A-F)</span>
<span class="sd">        the entire 4 byte value will instead be decoded as an unsigned integer,</span>
<span class="sd">        and negated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Not valid BCD, treat as an unsigned integer, and return a negative value</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="EXTENDED_CAPABILITY_FLAGS"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.EXTENDED_CAPABILITY_FLAGS">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">EXTENDED_CAPABILITY_FLAGS</span><span class="p">(</span><span class="n">IntFlag</span><span class="p">):</span>
    <span class="n">KDF</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">PSO_DEC_ENC_AES</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">ALGORITHM_ATTRIBUTES_CHANGEABLE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">PRIVATE_USE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">PW_STATUS_CHANGEABLE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">KEY_IMPORT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">GET_CHALLENGE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">SECURE_MESSAGING</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span></div>


<div class="viewcode-block" id="CardholderRelatedData"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.CardholderRelatedData">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CardholderRelatedData</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">sex</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="CardholderRelatedData.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.CardholderRelatedData.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CardholderRelatedData&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">CARDHOLDER_RELATED_DATA</span><span class="p">,</span> <span class="n">encoded</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">NAME</span><span class="p">],</span>
            <span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">LANGUAGE</span><span class="p">],</span>
            <span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">SEX</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="ExtendedLengthInfo"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ExtendedLengthInfo">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExtendedLengthInfo</span><span class="p">:</span>
    <span class="n">request_max_bytes</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">response_max_bytes</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="ExtendedLengthInfo.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ExtendedLengthInfo.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExtendedLengthInfo&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_list</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="GENERAL_FEATURE_MANAGEMENT"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.GENERAL_FEATURE_MANAGEMENT">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">GENERAL_FEATURE_MANAGEMENT</span><span class="p">(</span><span class="n">IntFlag</span><span class="p">):</span>
    <span class="n">TOUCHSCREEN</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">MICROPHONE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">LOUDSPEAKER</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">LED</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">KEYPAD</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">BUTTON</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">BIOMETRIC</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">DISPLAY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span></div>


<div class="viewcode-block" id="ExtendedCapabilities"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ExtendedCapabilities">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExtendedCapabilities</span><span class="p">:</span>
    <span class="n">flags</span><span class="p">:</span> <span class="n">EXTENDED_CAPABILITY_FLAGS</span>
    <span class="n">sm_algorithm</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">challenge_max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">certificate_max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">special_do_max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pin_block_2_format</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">mse_command</span><span class="p">:</span> <span class="nb">bool</span>

<div class="viewcode-block" id="ExtendedCapabilities.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ExtendedCapabilities.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExtendedCapabilities&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="PwStatus"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PwStatus">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PwStatus</span><span class="p">:</span>
    <span class="n">pin_policy_user</span><span class="p">:</span> <span class="n">PIN_POLICY</span>
    <span class="n">max_len_user</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_len_reset</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_len_admin</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">attempts_user</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">attempts_reset</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">attempts_admin</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="PwStatus.get_max_len"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PwStatus.get_max_len">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;max_len_</span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwStatus.get_attempts"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PwStatus.get_attempts">[docs]</a>    <span class="k">def</span> <span class="nf">get_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;attempts_</span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PwStatus.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PwStatus.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PwStatus&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">PIN_POLICY</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">PIN_POLICY</span><span class="o">.</span><span class="n">ONCE</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">policy</span><span class="p">,</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">encoded</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CRT"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.CRT">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">CRT</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Control Reference Template values.&quot;&quot;&quot;</span>

    <span class="n">SIG</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0xB6</span><span class="p">)</span>
    <span class="n">DEC</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0xB8</span><span class="p">)</span>
    <span class="n">AUT</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0xA4</span><span class="p">)</span>
    <span class="n">ATT</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0xB6</span><span class="p">,</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x84</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x81</span><span class="s2">&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="KEY_REF"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KEY_REF">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">KEY_REF</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
    <span class="n">SIG</span> <span class="o">=</span> <span class="mh">0x01</span>
    <span class="n">DEC</span> <span class="o">=</span> <span class="mh">0x02</span>
    <span class="n">AUT</span> <span class="o">=</span> <span class="mh">0x03</span>
    <span class="n">ATT</span> <span class="o">=</span> <span class="mh">0x81</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algorithm_attributes_do</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DO</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">DO</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ALGORITHM_ATTRIBUTES_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uif_do</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DO</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">DO</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;UIF_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generation_time_do</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DO</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">DO</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GENERATION_TIME_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fingerprint_do</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DO</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">DO</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FINGERPRINT_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CRT</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">CRT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="KEY_STATUS"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KEY_STATUS">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">KEY_STATUS</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">GENERATED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IMPORTED</span> <span class="o">=</span> <span class="mi">2</span></div>


<span class="n">KeyInformation</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">KEY_REF</span><span class="p">,</span> <span class="n">KEY_STATUS</span><span class="p">]</span>
<span class="n">Fingerprints</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">KEY_REF</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span>
<span class="n">GenerationTimes</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">KEY_REF</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="n">EcPublicKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">,</span>
    <span class="n">ed25519</span><span class="o">.</span><span class="n">Ed25519PublicKey</span><span class="p">,</span>
    <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PublicKey</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">PublicKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">EcPublicKey</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">]</span>
<span class="n">EcPrivateKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePrivateKeyWithSerialization</span><span class="p">,</span>
    <span class="n">ed25519</span><span class="o">.</span><span class="n">Ed25519PrivateKey</span><span class="p">,</span>
    <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PrivateKey</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">PrivateKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKeyWithSerialization</span><span class="p">,</span>
    <span class="n">EcPrivateKey</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1"># mypy doesn&#39;t handle abstract dataclasses well</span>
<div class="viewcode-block" id="AlgorithmAttributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.AlgorithmAttributes">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># type: ignore[misc]</span>
<span class="k">class</span> <span class="nc">AlgorithmAttributes</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenPGP key algorithm attributes.&quot;&quot;&quot;</span>

    <span class="n">_supported_ids</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
    <span class="n">algorithm_id</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="AlgorithmAttributes.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.AlgorithmAttributes.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AlgorithmAttributes&quot;</span><span class="p">:</span>
        <span class="n">algorithm_id</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sub_cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">algorithm_id</span> <span class="ow">in</span> <span class="n">sub_cls</span><span class="o">.</span><span class="n">_supported_ids</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sub_cls</span><span class="o">.</span><span class="n">_parse_data</span><span class="p">(</span><span class="n">algorithm_id</span><span class="p">,</span> <span class="n">encoded</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported algorithm ID&quot;</span><span class="p">)</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">alg</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AlgorithmAttributes&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="RSA_SIZE"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RSA_SIZE">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">RSA_SIZE</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">RSA2048</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="n">RSA3072</span> <span class="o">=</span> <span class="mi">3072</span>
    <span class="n">RSA4096</span> <span class="o">=</span> <span class="mi">4096</span></div>


<div class="viewcode-block" id="RSA_IMPORT_FORMAT"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RSA_IMPORT_FORMAT">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">RSA_IMPORT_FORMAT</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">STANDARD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STANDARD_W_MOD</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CRT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">CRT_W_MOD</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="RsaAttributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RsaAttributes">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RsaAttributes</span><span class="p">(</span><span class="n">AlgorithmAttributes</span><span class="p">):</span>
    <span class="n">_supported_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x01</span><span class="p">]</span>

    <span class="n">n_len</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">e_len</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">import_format</span><span class="p">:</span> <span class="n">RSA_IMPORT_FORMAT</span>

<div class="viewcode-block" id="RsaAttributes.create"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RsaAttributes.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">n_len</span><span class="p">:</span> <span class="n">RSA_SIZE</span><span class="p">,</span>
        <span class="n">import_format</span><span class="p">:</span> <span class="n">RSA_IMPORT_FORMAT</span> <span class="o">=</span> <span class="n">RSA_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RsaAttributes&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">n_len</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">import_format</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RsaAttributes&quot;</span><span class="p">:</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;HHB&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">RSA_IMPORT_FORMAT</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
            <span class="s2">&quot;&gt;BHHB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_format</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CurveOid"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.CurveOid">[docs]</a><span class="k">class</span> <span class="nc">CurveOid</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">OID</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">oid</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">oid</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="s2">&quot;Unknown Curve&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<span class="k">class</span> <span class="nc">OID</span><span class="p">(</span><span class="n">CurveOid</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">SECP256R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2a\x86\x48\xce\x3d\x03\x01\x07</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">SECP256K1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x81\x04\x00\x0a</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">SECP384R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x81\x04\x00\x22</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">SECP521R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x81\x04\x00\x23</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">BrainpoolP256R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x24\x03\x03\x02\x08\x01\x01\x07</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">BrainpoolP384R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x24\x03\x03\x02\x08\x01\x01\x0b</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">BrainpoolP512R1</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x24\x03\x03\x02\x08\x01\x01\x0d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">X25519</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x06\x01\x04\x01\x97\x55\x01\x05\x01</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">Ed25519</span> <span class="o">=</span> <span class="n">CurveOid</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2b\x06\x01\x04\x01\xda\x47\x0f\x01</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="n">EcPrivateKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CurveOid</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePrivateKey</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">ed25519</span><span class="o">.</span><span class="n">Ed25519PrivateKey</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ed25519&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PrivateKey</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;x25519&quot;</span>
        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oid</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">oid</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported private key&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="EC_IMPORT_FORMAT"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.EC_IMPORT_FORMAT">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">EC_IMPORT_FORMAT</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">STANDARD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STANDARD_W_PUBKEY</span> <span class="o">=</span> <span class="mh">0xFF</span></div>


<div class="viewcode-block" id="EcAttributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.EcAttributes">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">EcAttributes</span><span class="p">(</span><span class="n">AlgorithmAttributes</span><span class="p">):</span>
    <span class="n">_supported_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">]</span>

    <span class="n">oid</span><span class="p">:</span> <span class="n">CurveOid</span>
    <span class="n">import_format</span><span class="p">:</span> <span class="n">EC_IMPORT_FORMAT</span>

<div class="viewcode-block" id="EcAttributes.create"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.EcAttributes.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">oid</span><span class="p">:</span> <span class="n">CurveOid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EcAttributes&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">oid</span> <span class="o">==</span> <span class="n">OID</span><span class="o">.</span><span class="n">Ed25519</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="mh">0x16</span>  <span class="c1"># EdDSA</span>
        <span class="k">elif</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="mh">0x12</span>  <span class="c1"># ECDH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="mh">0x13</span>  <span class="c1"># ECDSA</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EcAttributes&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoded</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD_W_PUBKEY</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Standard is defined as &quot;format byte not present&quot;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">encoded</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">CurveOid</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_id</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">oid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_format</span> <span class="o">==</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD_W_PUBKEY</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_format</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buf</span></div>


<span class="k">def</span> <span class="nf">_parse_key_information</span><span class="p">(</span><span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KeyInformation</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">KEY_REF</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="n">KEY_STATUS</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_parse_fingerprints</span><span class="p">(</span><span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Fingerprints</span><span class="p">:</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">KEY_REF</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">encoded</span><span class="p">[</span><span class="n">o</span> <span class="p">:</span> <span class="n">o</span> <span class="o">+</span> <span class="mi">20</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_parse_timestamps</span><span class="p">(</span><span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenerationTimes</span><span class="p">:</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">KEY_REF</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">bytes2int</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">o</span> <span class="p">:</span> <span class="n">o</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
    <span class="p">}</span>


<div class="viewcode-block" id="DiscretionaryDataObjects"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.DiscretionaryDataObjects">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DiscretionaryDataObjects</span><span class="p">:</span>
    <span class="n">extended_capabilities</span><span class="p">:</span> <span class="n">ExtendedCapabilities</span>
    <span class="n">attributes_sig</span><span class="p">:</span> <span class="n">AlgorithmAttributes</span>
    <span class="n">attributes_dec</span><span class="p">:</span> <span class="n">AlgorithmAttributes</span>
    <span class="n">attributes_aut</span><span class="p">:</span> <span class="n">AlgorithmAttributes</span>
    <span class="n">attributes_att</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AlgorithmAttributes</span><span class="p">]</span>
    <span class="n">pw_status</span><span class="p">:</span> <span class="n">PwStatus</span>
    <span class="n">fingerprints</span><span class="p">:</span> <span class="n">Fingerprints</span>
    <span class="n">ca_fingerprints</span><span class="p">:</span> <span class="n">Fingerprints</span>
    <span class="n">generation_times</span><span class="p">:</span> <span class="n">GenerationTimes</span>
    <span class="n">key_information</span><span class="p">:</span> <span class="n">KeyInformation</span>
    <span class="n">uif_sig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UIF</span><span class="p">]</span>
    <span class="n">uif_dec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UIF</span><span class="p">]</span>
    <span class="n">uif_aut</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UIF</span><span class="p">]</span>
    <span class="n">uif_att</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UIF</span><span class="p">]</span>

<div class="viewcode-block" id="DiscretionaryDataObjects.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.DiscretionaryDataObjects.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DiscretionaryDataObjects&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ExtendedCapabilities</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_EXTENDED_CAPABILITIES</span><span class="p">]),</span>
            <span class="n">AlgorithmAttributes</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_SIG</span><span class="p">]),</span>
            <span class="n">AlgorithmAttributes</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_DEC</span><span class="p">]),</span>
            <span class="n">AlgorithmAttributes</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_AUT</span><span class="p">]),</span>
            <span class="p">(</span>
                <span class="n">AlgorithmAttributes</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_ATT</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_ATT</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="n">PwStatus</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">PW_STATUS_BYTES</span><span class="p">]),</span>
            <span class="n">_parse_fingerprints</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_FINGERPRINTS</span><span class="p">]),</span>
            <span class="n">_parse_fingerprints</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_CA_FINGERPRINTS</span><span class="p">]),</span>
            <span class="n">_parse_timestamps</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_GENERATION_TIMES</span><span class="p">]),</span>
            <span class="n">_parse_key_information</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TAG_KEY_INFORMATION</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">UIF_SIG</span><span class="p">])</span> <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">UIF_SIG</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">UIF_DEC</span><span class="p">])</span> <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">UIF_DEC</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">UIF_AUT</span><span class="p">])</span> <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">UIF_AUT</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">UIF</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">UIF_ATT</span><span class="p">])</span> <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">UIF_ATT</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DiscretionaryDataObjects.get_algorithm_attributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.DiscretionaryDataObjects.get_algorithm_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AlgorithmAttributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;attributes_</span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ApplicationRelatedData"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ApplicationRelatedData">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ApplicationRelatedData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenPGP related data.&quot;&quot;&quot;</span>

    <span class="n">aid</span><span class="p">:</span> <span class="n">OpenPgpAid</span>
    <span class="n">historical</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">extended_length_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExtendedLengthInfo</span><span class="p">]</span>
    <span class="n">general_feature_management</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GENERAL_FEATURE_MANAGEMENT</span><span class="p">]</span>
    <span class="n">discretionary</span><span class="p">:</span> <span class="n">DiscretionaryDataObjects</span>

<div class="viewcode-block" id="ApplicationRelatedData.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.ApplicationRelatedData.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ApplicationRelatedData&quot;</span><span class="p">:</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">APPLICATION_RELATED_DATA</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">OpenPgpAid</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">AID</span><span class="p">]),</span>
            <span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">HISTORICAL_BYTES</span><span class="p">],</span>
            <span class="p">(</span>
                <span class="n">ExtendedLengthInfo</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">EXTENDED_LENGTH_INFO</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">EXTENDED_LENGTH_INFO</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="n">GENERAL_FEATURE_MANAGEMENT</span><span class="p">(</span>
                    <span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="mh">0x81</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">DO</span><span class="o">.</span><span class="n">GENERAL_FEATURE_MANAGEMENT</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">DO</span><span class="o">.</span><span class="n">GENERAL_FEATURE_MANAGEMENT</span> <span class="ow">in</span> <span class="n">data</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
            <span class="c1"># Older keys have data in outer dict</span>
            <span class="n">DiscretionaryDataObjects</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_DISCRETIONARY</span><span class="p">]</span> <span class="ow">or</span> <span class="n">outer</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="SecuritySupportTemplate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.SecuritySupportTemplate">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SecuritySupportTemplate</span><span class="p">:</span>
    <span class="n">signature_counter</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="SecuritySupportTemplate.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.SecuritySupportTemplate.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SecuritySupportTemplate&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">SECURITY_SUPPORT_TEMPLATE</span><span class="p">,</span> <span class="n">encoded</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">TAG_SIGNATURE_COUNTER</span><span class="p">]))</span></div></div>


<span class="c1"># mypy doesn&#39;t handle abstract dataclasses well</span>
<div class="viewcode-block" id="Kdf"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.Kdf">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># type: ignore[misc]</span>
<span class="k">class</span> <span class="nc">Kdf</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<div class="viewcode-block" id="Kdf.process"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.Kdf.process">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the KDF on the input PIN.&quot;&quot;&quot;</span></div>

    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Kdf&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="Kdf.parse"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.Kdf.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encoded</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Kdf&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mh">0x81</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">algorithm</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">_parse_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Fall though to KdfNone</span>
        <span class="k">return</span> <span class="n">KdfNone</span><span class="p">()</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="KdfNone"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfNone">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">KdfNone</span><span class="p">(</span><span class="n">Kdf</span><span class="p">):</span>
    <span class="n">algorithm</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;KdfNone&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span>

<div class="viewcode-block" id="KdfNone.process"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfNone.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pin</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x81</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">))</span></div>


<div class="viewcode-block" id="HASH_ALGORITHM"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.HASH_ALGORITHM">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">HASH_ALGORITHM</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">SHA256</span> <span class="o">=</span> <span class="mh">0x08</span>
    <span class="n">SHA512</span> <span class="o">=</span> <span class="mh">0x0A</span>

<div class="viewcode-block" id="HASH_ALGORITHM.create_digest"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.HASH_ALGORITHM.create_digest">[docs]</a>    <span class="k">def</span> <span class="nf">create_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashes</span><span class="o">.</span><span class="n">Hash</span><span class="p">(</span><span class="n">algorithm</span><span class="p">(),</span> <span class="n">default_backend</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="KdfIterSaltedS2k"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfIterSaltedS2k">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">KdfIterSaltedS2k</span><span class="p">(</span><span class="n">Kdf</span><span class="p">):</span>
    <span class="n">algorithm</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">hash_algorithm</span><span class="p">:</span> <span class="n">HASH_ALGORITHM</span>
    <span class="n">iteration_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">salt_user</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">salt_reset</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">salt_admin</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">initial_hash_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span>
    <span class="n">initial_hash_admin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_do_process</span><span class="p">(</span><span class="n">hash_algorithm</span><span class="p">,</span> <span class="n">iteration_count</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Although the field is called &quot;iteration count&quot;, it&#39;s actually</span>
        <span class="c1"># the number of bytes to be passed to the hash function, which</span>
        <span class="c1"># is called only once. Go figure!</span>
        <span class="n">data_count</span><span class="p">,</span> <span class="n">trailing_bytes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">iteration_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hash_algorithm</span><span class="o">.</span><span class="n">create_digest</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_count</span><span class="p">):</span>
            <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">trailing_bytes</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

<div class="viewcode-block" id="KdfIterSaltedS2k.create"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfIterSaltedS2k.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">hash_algorithm</span><span class="p">:</span> <span class="n">HASH_ALGORITHM</span> <span class="o">=</span> <span class="n">HASH_ALGORITHM</span><span class="o">.</span><span class="n">SHA256</span><span class="p">,</span>
        <span class="n">iteration_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x780000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;KdfIterSaltedS2k&quot;</span><span class="p">:</span>
        <span class="n">salt_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">salt_admin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">hash_algorithm</span><span class="p">,</span>
            <span class="n">iteration_count</span><span class="p">,</span>
            <span class="n">salt_user</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">salt_admin</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_do_process</span><span class="p">(</span>
                <span class="n">hash_algorithm</span><span class="p">,</span> <span class="n">iteration_count</span><span class="p">,</span> <span class="n">salt_user</span> <span class="o">+</span> <span class="n">DEFAULT_USER_PIN</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_do_process</span><span class="p">(</span>
                <span class="n">hash_algorithm</span><span class="p">,</span> <span class="n">iteration_count</span><span class="p">,</span> <span class="n">salt_admin</span> <span class="o">+</span> <span class="n">DEFAULT_ADMIN_PIN</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;KdfIterSaltedS2k&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">HASH_ALGORITHM</span><span class="p">(</span><span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mh">0x82</span><span class="p">])),</span>
            <span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mh">0x83</span><span class="p">]),</span>
            <span class="n">data</span><span class="p">[</span><span class="mh">0x84</span><span class="p">],</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x85</span><span class="p">),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x86</span><span class="p">),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x87</span><span class="p">),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x88</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="KdfIterSaltedS2k.get_salt"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfIterSaltedS2k.get_salt">[docs]</a>    <span class="k">def</span> <span class="nf">get_salt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;salt_</span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KdfIterSaltedS2k.process"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.KdfIterSaltedS2k.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_salt</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_user</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">salt</span> <span class="o">+</span> <span class="n">pin</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_algorithm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x81</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x82</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_algorithm</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x83</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x84</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_user</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">Tlv</span><span class="p">(</span><span class="mh">0x85</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_reset</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_reset</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">Tlv</span><span class="p">(</span><span class="mh">0x86</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_admin</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">salt_admin</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">Tlv</span><span class="p">(</span><span class="mh">0x87</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_hash_user</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_hash_user</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">Tlv</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_hash_admin</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_hash_admin</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>


<span class="c1"># mypy doesn&#39;t handle abstract dataclasses well</span>
<div class="viewcode-block" id="PrivateKeyTemplate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.PrivateKeyTemplate">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># type: ignore[misc]</span>
<span class="k">class</span> <span class="nc">PrivateKeyTemplate</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">crt</span><span class="p">:</span> <span class="n">CRT</span>

    <span class="k">def</span> <span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tlv</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">tlvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Tlv</span><span class="p">(</span>
            <span class="mh">0x4D</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt</span>
            <span class="o">+</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x7F48</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tlv</span><span class="p">[:</span> <span class="o">-</span><span class="n">tlv</span><span class="o">.</span><span class="n">length</span><span class="p">]</span> <span class="k">for</span> <span class="n">tlv</span> <span class="ow">in</span> <span class="n">tlvs</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x5F48</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tlv</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">tlv</span> <span class="ow">in</span> <span class="n">tlvs</span><span class="p">)),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RsaKeyTemplate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RsaKeyTemplate">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RsaKeyTemplate</span><span class="p">(</span><span class="n">PrivateKeyTemplate</span><span class="p">):</span>
    <span class="n">e</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">p</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">q</span><span class="p">:</span> <span class="nb">bytes</span>

    <span class="k">def</span> <span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x91</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x92</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x93</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RsaCrtKeyTemplate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.RsaCrtKeyTemplate">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RsaCrtKeyTemplate</span><span class="p">(</span><span class="n">RsaKeyTemplate</span><span class="p">):</span>
    <span class="n">iqmp</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">dmp1</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">dmq1</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">bytes</span>

    <span class="k">def</span> <span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">*</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_template</span><span class="p">(),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x94</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iqmp</span><span class="p">),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmp1</span><span class="p">),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x96</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmq1</span><span class="p">),</span>
            <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x97</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EcKeyTemplate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.EcKeyTemplate">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">EcKeyTemplate</span><span class="p">(</span><span class="n">PrivateKeyTemplate</span><span class="p">):</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">public_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tlvs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tlv</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tlv</span><span class="p">(</span><span class="mh">0x92</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">),)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">:</span>
            <span class="n">tlvs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">tlvs</span><span class="p">,</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tlvs</span></div>


<span class="k">def</span> <span class="nf">_get_key_attributes</span><span class="p">(</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Version</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AlgorithmAttributes</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKeyWithSerialization</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span><span class="o">.</span><span class="n">public_numbers</span><span class="o">.</span><span class="n">e</span> <span class="o">!=</span> <span class="mi">65537</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RSA keys with e != 65537 are not supported!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">RSA_SIZE</span><span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">key_size</span><span class="p">),</span>
            <span class="n">RSA_IMPORT_FORMAT</span><span class="o">.</span><span class="n">CRT_W_MOD</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">RSA_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">EcAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key_ref</span><span class="p">,</span> <span class="n">OID</span><span class="o">.</span><span class="n">_from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_key_template</span><span class="p">(</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">use_crt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PrivateKeyTemplate</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKeyWithSerialization</span><span class="p">):</span>
        <span class="n">rsa_numbers</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">key_size</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">e</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x01\x00\x01</span><span class="s2">&quot;</span>  <span class="c1"># e=65537</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_crt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RsaKeyTemplate</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">dmp1</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
            <span class="n">dq</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">dmq1</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
            <span class="n">qinv</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">iqmp</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">rsa_numbers</span><span class="o">.</span><span class="n">public_numbers</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ln</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RsaCrtKeyTemplate</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qinv</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dq</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePrivateKeyWithSerialization</span><span class="p">):</span>
        <span class="n">ec_numbers</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_numbers</span><span class="p">()</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">key_size</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">EcKeyTemplate</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">,</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">ec_numbers</span><span class="o">.</span><span class="n">private_value</span><span class="p">,</span> <span class="n">ln</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="p">(</span><span class="n">ed25519</span><span class="o">.</span><span class="n">Ed25519PrivateKey</span><span class="p">,</span> <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PrivateKey</span><span class="p">)):</span>
        <span class="n">pkb</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">PrivateFormat</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">NoEncryption</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PrivateKey</span><span class="p">):</span>
            <span class="n">pkb</span> <span class="o">=</span> <span class="n">pkb</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># byte order needs to be reversed</span>
        <span class="k">return</span> <span class="n">EcKeyTemplate</span><span class="p">(</span>
            <span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">,</span>
            <span class="n">pkb</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported key type&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_rsa_key</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">:</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicNumbers</span><span class="p">(</span><span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mh">0x82</span><span class="p">]),</span> <span class="n">bytes2int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mh">0x81</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">numbers</span><span class="o">.</span><span class="n">public_key</span><span class="p">(</span><span class="n">default_backend</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_parse_ec_key</span><span class="p">(</span><span class="n">oid</span><span class="p">:</span> <span class="n">CurveOid</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">EcPublicKey</span><span class="p">:</span>
    <span class="n">pubkey_enc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mh">0x86</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">oid</span> <span class="o">==</span> <span class="n">OID</span><span class="o">.</span><span class="n">X25519</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PublicKey</span><span class="o">.</span><span class="n">from_public_bytes</span><span class="p">(</span><span class="n">pubkey_enc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">oid</span> <span class="o">==</span> <span class="n">OID</span><span class="o">.</span><span class="n">Ed25519</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ed25519</span><span class="o">.</span><span class="n">Ed25519PublicKey</span><span class="o">.</span><span class="n">from_public_bytes</span><span class="p">(</span><span class="n">pubkey_enc</span><span class="p">)</span>

    <span class="n">curve</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">oid</span><span class="o">.</span><span class="n">_get_name</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="o">.</span><span class="n">from_encoded_point</span><span class="p">(</span><span class="n">curve</span><span class="p">(),</span> <span class="n">pubkey_enc</span><span class="p">)</span>


<span class="n">_pkcs1v15_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">MD5</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3020300C06082A864886F70D020505000410&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3021300906052B0E03021A05000414&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA224</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;302D300D06096086480165030402040500041C&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3031300D060960864801650304020105000420&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA384</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3041300D060960864801650304020205000430&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA512</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3051300D060960864801650304020305000440&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA512_224</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;302D300D06096086480165030402050500041C&quot;</span><span class="p">),</span>
    <span class="n">hashes</span><span class="o">.</span><span class="n">SHA512_256</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;3031300D060960864801650304020605000420&quot;</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_pad_message</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hash_algorithm</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">algorithm_id</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">:</span>  <span class="c1"># EdDSA, never hash</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hash_algorithm</span><span class="p">,</span> <span class="n">Prehashed</span><span class="p">):</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">message</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashes</span><span class="o">.</span><span class="n">Hash</span><span class="p">(</span><span class="n">hash_algorithm</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
        <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">EcAttributes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">RsaAttributes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_pkcs1v15_headers</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">hash_algorithm</span><span class="p">)]</span> <span class="o">+</span> <span class="n">hashed</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported hash algorithm for RSA: </span><span class="si">{</span><span class="n">hash_algorithm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="OpenPgpSession"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession">[docs]</a><span class="k">class</span> <span class="nc">OpenPgpSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A session with the OpenPGP application.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">SmartCardConnection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SmartCardProtocol</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">AID</span><span class="o">.</span><span class="n">OPENPGP</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApduError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">sw</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SW</span><span class="o">.</span><span class="n">NO_INPUT_DATA</span><span class="p">,</span> <span class="n">SW</span><span class="o">.</span><span class="n">CONDITIONS_NOT_SATISFIED</span><span class="p">):</span>
                <span class="c1"># Not activated, activate</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Application not active, sending ACTIVATE&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">ACTIVATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">AID</span><span class="o">.</span><span class="n">OPENPGP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_version</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">enable_touch_workaround</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">apdu_format</span> <span class="o">=</span> <span class="n">ApduFormat</span><span class="o">.</span><span class="n">EXTENDED</span>

        <span class="c1"># Note: This value is cached!</span>
        <span class="c1"># Do not rely on contained information that can change!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_related_data</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenPGP session initialized (version=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Version</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting version number&quot;</span><span class="p">)</span>
        <span class="n">bcd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GET_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Version</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_bcd</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bcd</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">aid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenPgpAid</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AID used to select the applet.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_data</span><span class="o">.</span><span class="n">aid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Version</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the firmware version of the key.</span>

<span class="sd">        For YubiKey NEO this is the PGP applet version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extended_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExtendedCapabilities</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the Extended Capabilities from the YubiKey.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_data</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">extended_capabilities</span>

<div class="viewcode-block" id="OpenPgpSession.get_challenge"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_challenge">[docs]</a>    <span class="k">def</span> <span class="nf">get_challenge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get random data from the YubiKey.</span>

<span class="sd">        :param length: Length of the returned data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_capabilities</span>
        <span class="k">if</span> <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">GET_CHALLENGE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;GET_CHALLENGE is not supported&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">challenge_max_length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Unsupported challenge length&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2"> random bytes&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GET_CHALLENGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="n">length</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_data"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do</span><span class="p">:</span> <span class="n">DO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a Data Object from the YubiKey.</span>

<span class="sd">        :param do: The Data Object to get.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading Data Object </span><span class="si">{</span><span class="n">do</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">do</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GET_DATA</span><span class="p">,</span> <span class="n">do</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.put_data"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.put_data">[docs]</a>    <span class="k">def</span> <span class="nf">put_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do</span><span class="p">:</span> <span class="n">DO</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">SupportsBytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a Data Object to the YubiKey.</span>

<span class="sd">        :param do: The Data Object to write to.</span>
<span class="sd">        :param data: The data to write.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">PUT_DATA</span><span class="p">,</span> <span class="n">do</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote Data Object </span><span class="si">{</span><span class="n">do</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">do</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_pin_status"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_pin_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_pin_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PwStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current status of PINS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PwStatus</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">PW_STATUS_BYTES</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_signature_counter"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_signature_counter">[docs]</a>    <span class="k">def</span> <span class="nf">get_signature_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of times the signature key has been used.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">SecuritySupportTemplate</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">SECURITY_SUPPORT_TEMPLATE</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">signature_counter</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_application_related_data"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_application_related_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_application_related_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApplicationRelatedData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the Application Related Data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ApplicationRelatedData</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">APPLICATION_RELATED_DATA</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_signature_pin_policy"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_signature_pin_policy">[docs]</a>    <span class="k">def</span> <span class="nf">set_signature_pin_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_policy</span><span class="p">:</span> <span class="n">PIN_POLICY</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set signature PIN policy.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param pin_policy: The PIN policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting Signature PIN policy to </span><span class="si">{</span><span class="n">pin_policy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">pin_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">PW_STATUS_BYTES</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Signature PIN policy set&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.reset"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a factory reset on the OpenPGP application.</span>

<span class="sd">        WARNING: This will delete all stored keys, certificates and other data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Preparing OpenPGP reset&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure the User and Admin PINs are blocked</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pin_status</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">PW</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify </span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PIN with invalid attempts until blocked&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">get_attempts</span><span class="p">(</span><span class="n">pw</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">VERIFY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">_INVALID_PIN</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ApduError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># Reset the application</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending TERMINATE, then ACTIVATE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">TERMINATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">ACTIVATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OpenPGP application data reset performed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_pin_attempts"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_pin_attempts">[docs]</a>    <span class="k">def</span> <span class="nf">set_pin_attempts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reset_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">admin_attempts</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the number of PIN attempts to allow before blocking.</span>

<span class="sd">        WARNING: On YubiKey NEO this will reset the PINs to their default values.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param user_attempts: The User PIN attempts.</span>
<span class="sd">        :param reset_attempts: The Reset Code attempts.</span>
<span class="sd">        :param admin_attempts: The Admin PIN attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># YubiKey NEO</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">attempts</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_attempts</span><span class="p">,</span> <span class="n">reset_attempts</span><span class="p">,</span> <span class="n">admin_attempts</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting PIN attempts to </span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">INS</span><span class="o">.</span><span class="n">SET_PIN_RETRIES</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBB&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">attempts</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of PIN attempts has been changed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_kdf"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_kdf">[docs]</a>    <span class="k">def</span> <span class="nf">get_kdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the Key Derivation Function data object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">KDF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_capabilities</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">KdfNone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Kdf</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">KDF</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_kdf"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_kdf">[docs]</a>    <span class="k">def</span> <span class="nf">set_kdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kdf</span><span class="p">:</span> <span class="n">Kdf</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up a PIN Key Derivation Function.</span>

<span class="sd">        This enables (or disables) the use of a KDF for PIN verification, as well</span>
<span class="sd">        as resetting the User and Admin PINs to their default (initial) values.</span>

<span class="sd">        If a Reset Code is present, it will be invalidated.</span>

<span class="sd">        This command requires Admin PIN verification.</span>

<span class="sd">        :param kdf: The key derivation function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_data</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">extended_capabilities</span>
        <span class="k">if</span> <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">KDF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;KDF is not supported&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting PIN KDF to algorithm: </span><span class="si">{</span><span class="n">kdf</span><span class="o">.</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">KDF</span><span class="p">,</span> <span class="n">kdf</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;KDF settings changed&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pin_enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kdf</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">VERIFY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pw</span> <span class="o">+</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pin_enc</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApduError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">sw</span> <span class="o">==</span> <span class="n">SW</span><span class="o">.</span><span class="n">SECURITY_CONDITION_NOT_SATISFIED</span><span class="p">:</span>
                <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pin_status</span><span class="p">()</span><span class="o">.</span><span class="n">get_attempts</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InvalidPinError</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="OpenPgpSession.verify_pin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.verify_pin">[docs]</a>    <span class="k">def</span> <span class="nf">verify_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">extended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify the User PIN.</span>

<span class="sd">        This will unlock functionality that requires User PIN verification.</span>
<span class="sd">        Note that with `extended=False` (default) only sign operations are allowed.</span>
<span class="sd">        Inversely, with `extended=True` sign operations are NOT allowed.</span>

<span class="sd">        :param pin: The User PIN.</span>
<span class="sd">        :param extended: If `False` only sign operations are allowed,</span>
<span class="sd">            otherwise sign operations are NOT allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verifying User PIN in mode </span><span class="si">{</span><span class="s1">&#39;82&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">extended</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;81&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">extended</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.verify_admin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.verify_admin">[docs]</a>    <span class="k">def</span> <span class="nf">verify_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_pin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify the Admin PIN.</span>

<span class="sd">        This will unlock functionality that requires Admin PIN verification.</span>

<span class="sd">        :param admin_pin: The Admin PIN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verifying Admin PIN&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">,</span> <span class="n">admin_pin</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.unverify_pin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.unverify_pin">[docs]</a>    <span class="k">def</span> <span class="nf">unverify_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset verification for PIN.</span>

<span class="sd">        :param pw: The User, Admin or Reset PIN</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resetting verification for </span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PIN&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">VERIFY</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">:</span> <span class="n">PW</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing </span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PIN&quot;</span><span class="p">)</span>
        <span class="n">kdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kdf</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">INS</span><span class="o">.</span><span class="n">CHANGE_PIN</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">pw</span><span class="p">,</span>
                <span class="n">kdf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">+</span> <span class="n">kdf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ApduError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">sw</span> <span class="o">==</span> <span class="n">SW</span><span class="o">.</span><span class="n">SECURITY_CONDITION_NOT_SATISFIED</span><span class="p">:</span>
                <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pin_status</span><span class="p">()</span><span class="o">.</span><span class="n">get_attempts</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InvalidPinError</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New </span><span class="si">{</span><span class="n">pw</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PIN set&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="OpenPgpSession.change_pin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.change_pin">[docs]</a>    <span class="k">def</span> <span class="nf">change_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the User PIN.</span>

<span class="sd">        :param pin: The current User PIN.</span>
<span class="sd">        :param new_pin: The new User PIN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.change_admin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.change_admin">[docs]</a>    <span class="k">def</span> <span class="nf">change_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_admin_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the Admin PIN.</span>

<span class="sd">        :param admin_pin: The current Admin PIN.</span>
<span class="sd">        :param new_admin_pin: The new Admin PIN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">,</span> <span class="n">admin_pin</span><span class="p">,</span> <span class="n">new_admin_pin</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_reset_code"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_reset_code">[docs]</a>    <span class="k">def</span> <span class="nf">set_reset_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the Reset Code for User PIN.</span>

<span class="sd">        The Reset Code can be used to set a new User PIN if it is lost or becomes</span>
<span class="sd">        blocked, using the reset_pin method.</span>

<span class="sd">        This command requires Admin PIN verification.</span>

<span class="sd">        :param reset_code: The Reset Code for User PIN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting a new PIN Reset Code&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kdf</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">RESETTING_CODE</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New Reset Code has been set&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.reset_pin"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.reset_pin">[docs]</a>    <span class="k">def</span> <span class="nf">reset_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the User PIN to a new value.</span>

<span class="sd">        This command requires Admin PIN verification, or the Reset Code.</span>

<span class="sd">        :param new_pin: The new user PIN.</span>
<span class="sd">        :param reset_code: The Reset Code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Resetting User PIN&quot;</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">kdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kdf</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">kdf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">new_pin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_code</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using Reset Code&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">kdf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">PW</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">RESET_RETRY_COUNTER</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">PW</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApduError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">sw</span> <span class="o">==</span> <span class="n">SW</span><span class="o">.</span><span class="n">SECURITY_CONDITION_NOT_SATISFIED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reset_code</span><span class="p">:</span>
                <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pin_status</span><span class="p">()</span><span class="o">.</span><span class="n">attempts_reset</span>
                <span class="k">raise</span> <span class="n">InvalidPinError</span><span class="p">(</span>
                    <span class="n">attempts</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid Reset Code, </span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New User PIN has been set&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_algorithm_attributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_algorithm_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AlgorithmAttributes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the algorithm attributes for one of the key slots.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting Algorithm Attributes for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_related_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">get_algorithm_attributes</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_algorithm_information"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_algorithm_information">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_information</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">KEY_REF</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AlgorithmAttributes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of supported algorithm attributes for each key.</span>

<span class="sd">        The return value is a mapping of KEY_REF to a list of supported algorithm</span>
<span class="sd">        attributes, which can be set using set_algorithm_attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_CHANGEABLE</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_capabilities</span><span class="o">.</span><span class="n">flags</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Writing Algorithm Attributes is not supported&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA2048</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># Neo needs CRT</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">RSA_IMPORT_FORMAT</span><span class="o">.</span><span class="n">CRT_W_MOD</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">RSA_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>  <span class="c1"># Non-FIPS</span>
                    <span class="n">sizes</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA3072</span><span class="p">,</span> <span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA4096</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">KEY_REF</span><span class="o">.</span><span class="n">SIG</span><span class="p">:</span> <span class="p">[</span><span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">],</span>
                <span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">:</span> <span class="p">[</span><span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">],</span>
                <span class="n">KEY_REF</span><span class="o">.</span><span class="n">AUT</span><span class="p">:</span> <span class="p">[</span><span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting supported Algorithm Information&quot;</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_INFORMATION</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_INFORMATION</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ALGORITHM_INFORMATION</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0\0</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">slots</span> <span class="o">=</span> <span class="p">{</span><span class="n">slot</span><span class="o">.</span><span class="n">algorithm_attributes_do</span><span class="p">:</span> <span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">KEY_REF</span><span class="p">}</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">KEY_REF</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AlgorithmAttributes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tlv</span> <span class="ow">in</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_list</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">slots</span><span class="p">[</span><span class="n">DO</span><span class="p">(</span><span class="n">tlv</span><span class="o">.</span><span class="n">tag</span><span class="p">)],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AlgorithmAttributes</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tlv</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Fix for invalid Curve25519 entries:</span>
            <span class="c1"># Remove X25519 with EdDSA from all keys</span>
            <span class="n">invalid_x25519</span> <span class="o">=</span> <span class="n">EcAttributes</span><span class="p">(</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">OID</span><span class="o">.</span><span class="n">X25519</span><span class="p">,</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">invalid_x25519</span><span class="p">)</span>
            <span class="n">x25519</span> <span class="o">=</span> <span class="n">EcAttributes</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="n">OID</span><span class="o">.</span><span class="n">X25519</span><span class="p">,</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">)</span>
            <span class="c1"># Add X25519 ECDH for DEC</span>
            <span class="k">if</span> <span class="n">x25519</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">]:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x25519</span><span class="p">)</span>
            <span class="c1"># Remove EdDSA from DEC, ATT</span>
            <span class="n">ed25519_attr</span> <span class="o">=</span> <span class="n">EcAttributes</span><span class="p">(</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">OID</span><span class="o">.</span><span class="n">Ed25519</span><span class="p">,</span> <span class="n">EC_IMPORT_FORMAT</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ed25519_attr</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">ATT</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ed25519_attr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_algorithm_attributes"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_algorithm_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_algorithm_attributes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">AlgorithmAttributes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the algorithm attributes for a key slot.</span>

<span class="sd">        WARNING: This will delete any key already stored in the slot if the attributes</span>
<span class="sd">        are changed!</span>

<span class="sd">        This command requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param attributes: The algorithm attributes to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting Algorithm Attributes for </span><span class="si">{key_ref.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">supported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_information</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key_ref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Key slot not supported&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">[</span><span class="n">key_ref</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Algorithm attributes not supported&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">algorithm_attributes_do</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Algorithm Attributes have been changed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_uif"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_uif">[docs]</a>    <span class="k">def</span> <span class="nf">get_uif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UIF</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the User Interaction Flag (touch requirement) for a key.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UIF</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">uif_do</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ApduError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">sw</span> <span class="o">==</span> <span class="n">SW</span><span class="o">.</span><span class="n">WRONG_PARAMETERS_P1P2</span><span class="p">:</span>
                <span class="c1"># Not supported</span>
                <span class="k">return</span> <span class="n">UIF</span><span class="o">.</span><span class="n">OFF</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_uif"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_uif">[docs]</a>    <span class="k">def</span> <span class="nf">set_uif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">uif</span><span class="p">:</span> <span class="n">UIF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the User Interaction Flag (touch requirement) for a key.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param uif: The User Interaction Flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">ATT</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;Attestation key requires YubiKey 5.2.1 or later.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">uif</span><span class="o">.</span><span class="n">is_cached</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;Cached UIF values require YubiKey 5.2.1 or later.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting UIF for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">uif</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uif</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span><span class="o">.</span><span class="n">is_fixed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot change UIF when set to FIXED.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">uif_do</span><span class="p">,</span> <span class="n">uif</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UIF changed for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_key_information"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_key_information">[docs]</a>    <span class="k">def</span> <span class="nf">get_key_information</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KeyInformation</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the status of the keys.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Key Information&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_related_data</span><span class="p">()</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">key_information</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_generation_times"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_generation_times">[docs]</a>    <span class="k">def</span> <span class="nf">get_generation_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenerationTimes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get timestamps for when keys were generated.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting key generation timestamps&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_related_data</span><span class="p">()</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">generation_times</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_generation_time"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_generation_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_generation_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the generation timestamp for a key.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param timestamp: The timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting key generation timestamp for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">generation_time_do</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key generation timestamp set for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_fingerprints"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_fingerprints">[docs]</a>    <span class="k">def</span> <span class="nf">get_fingerprints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Fingerprints</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get key fingerprints.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting key fingerprints&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_related_data</span><span class="p">()</span><span class="o">.</span><span class="n">discretionary</span><span class="o">.</span><span class="n">fingerprints</span></div>

<div class="viewcode-block" id="OpenPgpSession.set_fingerprint"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.set_fingerprint">[docs]</a>    <span class="k">def</span> <span class="nf">set_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the fingerprint for a key.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param fingerprint: The fingerprint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting key fingerprint for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">key_ref</span><span class="o">.</span><span class="n">fingerprint_do</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Key fingerprint set for </span><span class="si">{key_ref.name}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.get_public_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_public_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PublicKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the public key from a slot.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting public key for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GENERATE_ASYM</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TAG_PUBLIC_KEY</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_attributes</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">EcAttributes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_parse_ec_key</span><span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># RSA</span>
            <span class="k">return</span> <span class="n">_parse_rsa_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.generate_rsa_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.generate_rsa_key">[docs]</a>    <span class="k">def</span> <span class="nf">generate_rsa_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">key_size</span><span class="p">:</span> <span class="n">RSA_SIZE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPublicKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an RSA key in the given slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param key_size: The size of the RSA key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;RSA key generation not supported on this YubiKey&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating RSA private key for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_CHANGEABLE</span>
            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_capabilities</span><span class="o">.</span><span class="n">flags</span>
        <span class="p">):</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_algorithm_attributes</span><span class="p">(</span><span class="n">key_ref</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key_size</span> <span class="o">!=</span> <span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA2048</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;Algorithm attributes not supported&quot;</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GENERATE_ASYM</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TAG_PUBLIC_KEY</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RSA key generated for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_parse_rsa_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.generate_ec_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.generate_ec_key">[docs]</a>    <span class="k">def</span> <span class="nf">generate_ec_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">curve_oid</span><span class="p">:</span> <span class="n">CurveOid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EcPublicKey</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an EC key in the given slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param curve_oid: The curve OID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">curve_oid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OID</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Curve OID is not recognized&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating EC private key for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">EcAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">key_ref</span><span class="p">,</span> <span class="n">curve_oid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_algorithm_attributes</span><span class="p">(</span><span class="n">key_ref</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GENERATE_ASYM</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">key_ref</span><span class="o">.</span><span class="n">crt</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="n">Tlv</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TAG_PUBLIC_KEY</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EC key generated for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_parse_ec_key</span><span class="p">(</span><span class="n">curve_oid</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.put_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.put_key">[docs]</a>    <span class="k">def</span> <span class="nf">put_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import a private key into the given slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        :param private_key: The private key to import.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Importing a private key for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">_get_key_attributes</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">EXTENDED_CAPABILITY_FLAGS</span><span class="o">.</span><span class="n">ALGORITHM_ATTRIBUTES_CHANGEABLE</span>
            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_capabilities</span><span class="o">.</span><span class="n">flags</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_algorithm_attributes</span><span class="p">(</span><span class="n">key_ref</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">RsaAttributes</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">attributes</span><span class="o">.</span><span class="n">n_len</span> <span class="o">==</span> <span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA2048</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span><span class="s2">&quot;This YubiKey only supports RSA 2048 keys&quot;</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">_get_key_template</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">PUT_DATA_ODD</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">template</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Private key imported for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.delete_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.delete_key">[docs]</a>    <span class="k">def</span> <span class="nf">delete_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the contents of a key slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Import over the key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_key</span><span class="p">(</span>
                <span class="n">key_ref</span><span class="p">,</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="mi">65537</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Delete key by changing the key attributes twice.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span>  <span class="c1"># Use put_data to avoid checking for RSA 4096 support</span>
                <span class="n">key_ref</span><span class="o">.</span><span class="n">algorithm_attributes_do</span><span class="p">,</span> <span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA4096</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_algorithm_attributes</span><span class="p">(</span>
                <span class="n">key_ref</span><span class="p">,</span> <span class="n">RsaAttributes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">RSA_SIZE</span><span class="o">.</span><span class="n">RSA2048</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_select_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting certificate for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x5C</span><span class="p">,</span> <span class="n">int2bytes</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">CARDHOLDER_CERTIFICATE</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="c1"># These use a non-standard byte in the command.</span>
                <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x06</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">data</span>  <span class="c1"># 6 is the length of the data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">INS</span><span class="o">.</span><span class="n">SELECT_DATA</span><span class="p">,</span>
                <span class="mi">3</span> <span class="o">-</span> <span class="n">key_ref</span><span class="p">,</span>
                <span class="mh">0x04</span><span class="p">,</span>
                <span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">NotSupportedError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">AUT</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># Older version still support AUT, which is the default slot.</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="OpenPgpSession.get_certificate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.get_certificate">[docs]</a>    <span class="k">def</span> <span class="nf">get_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a certificate from a slot.</span>

<span class="sd">        :param key_ref: The slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting certificate for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">ATT</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ATT_CERTIFICATE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_certificate</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">CARDHOLDER_CERTIFICATE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No certificate found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_der_x509_certificate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span></div>

<div class="viewcode-block" id="OpenPgpSession.put_certificate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.put_certificate">[docs]</a>    <span class="k">def</span> <span class="nf">put_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">,</span> <span class="n">certificate</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import a certificate into a slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The slot.</span>
<span class="sd">        :param certificate: The X.509 certificate to import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cert_data</span> <span class="o">=</span> <span class="n">certificate</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">DER</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Importing certificate for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">ATT</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ATT_CERTIFICATE</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_certificate</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">CARDHOLDER_CERTIFICATE</span><span class="p">,</span> <span class="n">cert_data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate imported for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.delete_certificate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.delete_certificate">[docs]</a>    <span class="k">def</span> <span class="nf">delete_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a certificate in a slot.</span>

<span class="sd">        Requires Admin PIN verification.</span>

<span class="sd">        :param key_ref: The slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting certificate for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_ref</span> <span class="o">==</span> <span class="n">KEY_REF</span><span class="o">.</span><span class="n">ATT</span><span class="p">:</span>
            <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">ATT_CERTIFICATE</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_certificate</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">DO</span><span class="o">.</span><span class="n">CARDHOLDER_CERTIFICATE</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate deleted for key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.attest_key"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.attest_key">[docs]</a>    <span class="k">def</span> <span class="nf">attest_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">:</span> <span class="n">KEY_REF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an attestation certificate for a key.</span>

<span class="sd">        The certificte is written to the certificate slot for the key, and its</span>
<span class="sd">        content is returned.</span>

<span class="sd">        Requires User PIN verification.</span>

<span class="sd">        :param key_ref: The key slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">require_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attesting key </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">GET_ATTESTATION</span><span class="p">,</span> <span class="n">key_ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attestation certificate created for </span><span class="si">{</span><span class="n">key_ref</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_certificate</span><span class="p">(</span><span class="n">key_ref</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenPgpSession.sign"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.sign">[docs]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">hash_algorithm</span><span class="p">:</span> <span class="n">hashes</span><span class="o">.</span><span class="n">HashAlgorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign a message using the SIG key.</span>

<span class="sd">        Requires User PIN verification.</span>

<span class="sd">        :param message: The message to sign.</span>
<span class="sd">        :param hash_algorithm: The pre-signature hash algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_attributes</span><span class="p">(</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">SIG</span><span class="p">)</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">_pad_message</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hash_algorithm</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signing a message with </span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">PSO</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="n">padded</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Message signed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">algorithm_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">encode_dss_signature</span><span class="p">(</span>
                <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">[:</span><span class="n">ln</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span>
                <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">ln</span><span class="p">:],</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="OpenPgpSession.decrypt"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.decrypt">[docs]</a>    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">EcPublicKey</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt a value using the DEC key.</span>

<span class="sd">        For RSA the `value` should be an encrypted block.</span>
<span class="sd">        For ECDH the `value` should be a peer public-key to perform the key exchange</span>
<span class="sd">        with, and the result will be the derived shared secret.</span>

<span class="sd">        Requires (extended) User PIN verification.</span>

<span class="sd">        :param value: The value to decrypt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_attributes</span><span class="p">(</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">DEC</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decrypting a value with </span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ec</span><span class="o">.</span><span class="n">EllipticCurvePublicKey</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">X962</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="o">.</span><span class="n">UncompressedPoint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">x25519</span><span class="o">.</span><span class="n">X25519PublicKey</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Raw</span><span class="p">,</span> <span class="n">PublicFormat</span><span class="o">.</span><span class="n">Raw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">RsaAttributes</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">EcAttributes</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0xA6</span><span class="p">,</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x7F49</span><span class="p">,</span> <span class="n">Tlv</span><span class="p">(</span><span class="mh">0x86</span><span class="p">,</span> <span class="n">data</span><span class="p">)))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">PSO</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Value decrypted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="OpenPgpSession.authenticate"><a class="viewcode-back" href="../../rst/yubikit.html#yubikit.openpgp.OpenPgpSession.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">hash_algorithm</span><span class="p">:</span> <span class="n">hashes</span><span class="o">.</span><span class="n">HashAlgorithm</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Authenticate a message using the AUT key.</span>

<span class="sd">        Requires User PIN verification.</span>

<span class="sd">        :param message: The message to authenticate.</span>
<span class="sd">        :param hash_algorithm: The pre-authentication hash algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_attributes</span><span class="p">(</span><span class="n">KEY_REF</span><span class="o">.</span><span class="n">AUT</span><span class="p">)</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">_pad_message</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hash_algorithm</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authenticating a message with </span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_apdu</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">INS</span><span class="o">.</span><span class="n">INTERNAL_AUTHENTICATE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">padded</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Message authenticated&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">algorithm_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">encode_dss_signature</span><span class="p">(</span>
                <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">[:</span><span class="n">ln</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span>
                <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">ln</span><span class="p">:],</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Yubico.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>