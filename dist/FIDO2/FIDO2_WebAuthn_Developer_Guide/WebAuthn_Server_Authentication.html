<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>WebAuthn Server Authentication</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li class="active"><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/FIDO2">FIDO2</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide">FIDO2 WebAuthn Developer Guide</a></li>
<li class="active">WebAuthn Server Authentication</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/FIDO2">FIDO2</a><ul class="">
<li class="active"><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide">FIDO2 WebAuthn Developer Guide</a><ul class="">
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Overview.html">Overview</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Client_Registration.html">WebAuthn Client Registration</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Client_Authentication.html">WebAuthn Client Authentication</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Server_Overview.html">WebAuthn Server Overview</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Server_Registration.html">WebAuthn Server Registration</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Attestation.html">Attestation</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Resident_Keys.html">Resident Keys</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Registering_Multiple_Devices.html">Registering Multiple Devices</a></li>
<li class="active"><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Server_Authentication.html">WebAuthn Server Authentication</a>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Federation.html">Federation</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Account_Recovery.html">Account Recovery</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Migrating_from_U2F.html">Migrating from U2F</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Desktop_and_Mobile_Authentication.html">Desktop and Mobile Authentication</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/FAQ.html">FAQ</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Resources.html">Resources</a></li>
<li><a href="/FIDO2/FIDO2_WebAuthn_Developer_Guide/Terminology.html">Terminology</a></li>
</li></ul>
<li><a href="/FIDO2/Libraries">Libraries</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/developers.yubico.com/issues/new?title=Suggested%20edit%20for%20FIDO2/FIDO2_WebAuthn_Developer_Guide/WebAuthn_Server_Authentication" rel="noopener noreferrer" target="_blank"><i class="fa fa-pencil-square-o fa-lg"></i> Suggest Edits</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_fido2_webauthn_server_authentication">FIDO2 WebAuthn Server Authentication</h1>
<div class="sectionbody">
<div class="sect2">
<h3 id="_initiate_authentication">Initiate Authentication</h3>
<div class="paragraph"><p>Authentication works much like registration, except less complex because of the fewer parameters and absence of authenticator attestation complexities.</p></div>
<div class="paragraph"><p>To initiate an authentication operation, call the RelyingParty startAssertion method. The main parameter is the username of the user to authenticate, but even this is optional. If the username is not set, then the allowCredentials parameter will not be set. This means the user must use a client-side-resident credential to authenticate; also known as first-factor authentication.</p></div>
<div class="paragraph"><p>The startAssertion method returns an AssertionRequest containing the username, if any, and a PublicKeyCredentialRequestOptions instance which can be serialized to JSON, have its Base64 encoded byte arrays converted back into <code>Uint8Array`s, and passed as the publicKey argument to `navigator.credentials.get()</code>. Again, store the AssertionRequest in temporary storage so it can be passed as an argument to the RelyingParty finishAssertion method.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">AssertionRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="na">startAssertion</span><span class="o">(</span><span class="n">StartAssertionOptions</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">username</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"alice"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">jsonMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="k">return</span> <span class="n">json</span><span class="o">;</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_finish_authentication">Finish Authentication</h3>
<div class="paragraph"><p>After receiving the response from the client, construct a <code>PublicKeyCredential</code> from the response and wrap that in a FinishAssertionOptions along with the AssertionRequest used to initiate the request. Pass that argument to the RelyingParty finishAssertion method, which will return an AssertionResult. Be sure to remove the AssertionRequest from the pending requests storage to prevent retries.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">responseJson</span> <span class="o">=</span> <span class="cm">/* ... */</span><span class="o">;</span>

<span class="n">PublicKeyCredential</span><span class="o">&lt;</span><span class="n">AuthenticatorAssertionResponse</span><span class="o">,</span> <span class="n">ClientAssertionExtensionOutputs</span><span class="o">&gt;</span> <span class="n">pkc</span> <span class="o">=</span>
    <span class="n">jsonMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">responseJson</span><span class="o">,</span> <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">PublicKeyCredential</span><span class="o">&lt;</span><span class="n">AuthenticatorAssertionResponse</span><span class="o">,</span> <span class="n">ClientAssertionExtensionOutputs</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
<span class="o">});</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">AssertionResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="na">finishAssertion</span><span class="o">(</span><span class="n">FinishAssertionOptions</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
        <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">pkc</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">());</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AssertionFailedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
<span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">"Authentication failed"</span><span class="o">);</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, use the AssertionResult to update any database(s) and take other actions depending on your applicationâ€™s needs. In particular:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use the username and/or userHandle results to initiate a user session.
</p>
</li>
<li>
<p>
Update the stored signature count for the credential (identified by the credentialId result) to equal the value returned in the signatureCount result.
</p>
</li>
<li>
<p>
Inspect the warnings - ideally there should be none.
</p>
</li>
</ul></div>
<div class="paragraph"><p><a href="/FIDO2//FIDO2_WebAuthn_Developer_Guide/Federation.html">Next: Federation</a></p></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>